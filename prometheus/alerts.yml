groups:
  - name: vetclinic-alerts
    rules:
      - alert: InstanceDown
        expr: up == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Instance down"
          description: "Target {{ $labels.instance }} (job={{ $labels.job }}) is down for 30s."

      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[2m]))
            /
            sum(rate(http_requests_total[2m]))
          ) > 0.02
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "High 5xx error rate"
          description: "5xx ratio > 2% for 3m (check services/endpoints)."

      - alert: HeightDivergence
        expr: |
          (max(blockchain_chain_height) - min(blockchain_chain_height)) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Blockchain height divergence"
          description: "Nodes disagree on chain height for 2m. max-min={{ $value }}"

      - alert: ConsensusStuck
        expr: |
          max_over_time(blockchain_chain_height[3m]) - min_over_time(blockchain_chain_height[3m]) == 0
          and
          sum(rate(tx_submitted_total[3m])) > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Consensus stuck while traffic exists"
          description: "Height not increasing for 5m while tx are being submitted."
